<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8">
  <title>B-vagter i Storkøbenhavn</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; }
    body { font-family: Arial, sans-serif; }

    .legend {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: white;
      padding: 8px 12px;
      border-radius: 6px;
      box-shadow: 0 0 6px rgba(0,0,0,0.3);
      font-size: 14px;
      line-height: 1.5em;
    }
    .legend span {
      display: inline-block;
      width: 12px;
      height: 12px;
      margin-right: 6px;
      border-radius: 50%;
    }

    .controls {
      position: absolute;
      top: 10px;
      right: 10px;
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 0 6px rgba(0,0,0,0.3);
    }
    .controls button {
      display: block;
      width: 160px;
      margin: 5px auto;
      padding: 6px 8px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      color: white;
      background-color: #28a745; /* Grøn standard */
      transition: background 0.3s;
    }
    .controls button.active {
      background-color: #dc3545; /* Rød aktiv */
    }
    .controls select {
      display: block;
      margin: 10px auto;
      padding: 5px;
      width: 160px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="controls">
    <select id="daySelector" onchange="loadDay(this.value)">
      <option value="lordag.json">Lørdag</option>
      <option value="sondag.json">Søndag</option>
    </select>

    <button id="morgenBtn" onclick="filterByTime('Morgen')">Morgen</button>
    <button id="aftenBtn" onclick="filterByTime('Aften')">Aften</button>
    <button id="natBtn" onclick="filterByTime('Nat')">Nat</button>

    <button id="indvBtn" onclick="filterByType('indvendig')">Indvendige</button>
    <button id="udvBtn" onclick="filterByType('udvendig')">Udvendige</button>
    <button id="beggeBtn" onclick="filterByType('begge')">Begge dele</button>
  </div>

  <div class="legend">
    <div><span style="background: blue"></span> B1-vagt</div>
    <div><span style="background: red"></span> B2-vagt</div>
    <div><span style="background: green"></span> B3-vagt</div>
  </div>

  <script>
    // Init Leaflet kort
    const map = L.map('map').setView([55.6761, 12.5683], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '© OpenStreetMap'
    }).addTo(map);

    const colors = { B1: "blue", B2: "red", B3: "green" };
    let allMarkers = [];
    let currentData = null;
    let activeTimeFilter = null;
    let activeTypeFilter = null;

    // --- AJAX loader ---
    function loadDay(fileName) {
      const xhr = new XMLHttpRequest();
      xhr.open("GET", fileName, true);
      xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
          if (xhr.status === 200) {
            try {
              const data = JSON.parse(xhr.responseText);
              currentData = data;
              updateMap();
            } catch (e) {
              console.error("JSON-fejl:", e);
              alert("Kunne ikke læse JSON-data korrekt.");
            }
          } else {
            console.error("Fejl ved hentning:", xhr.status);
            alert("Kunne ikke hente " + fileName);
          }
        }
      };
      xhr.send();
    }

    // --- Opdater kort ---
    function updateMap() {
      // Fjern gamle markører
      allMarkers.forEach(marker => map.removeLayer(marker));
      allMarkers = [];

      if (!currentData) return;

      const bounds = L.latLngBounds();
      for (const [shift, locations] of Object.entries(currentData)) {
        locations.forEach(loc => {
          if (activeTimeFilter && loc.tidSektion !== activeTimeFilter) return;
          if (activeTypeFilter && loc.rundering !== activeTypeFilter) return;

          const marker = L.circleMarker([loc.lat, loc.lng], {
            color: colors[shift],
            radius: 6,
            fillOpacity: 0.8
          })
          .bindPopup(`<b>${shift}</b><br>${loc.adresse}<br><b>Tid:</b> ${loc.tid}<br><b>Rundering:</b> ${loc.rundering}<br><b>Bemærkninger:</b> ${loc.bemærkninger || ''}`)
          .on('mouseover', function() { this.openPopup(); })
          .on('mouseout', function() { this.closePopup(); });

          marker.addTo(map);
          allMarkers.push(marker);
          bounds.extend([loc.lat, loc.lng]);
        });
      }
      if (bounds.isValid()) map.fitBounds(bounds);
    }

    // --- Filtrering efter tid ---
    function filterByTime(section) {
      const btn = document.getElementById(section.toLowerCase() + "Btn");
      const allTimeButtons = ["morgenBtn", "aftenBtn", "natBtn"];
      allTimeButtons.forEach(id => document.getElementById(id).classList.remove("active"));

      if (activeTimeFilter === section) {
        activeTimeFilter = null;
        updateMap();
        return;
      }
      activeTimeFilter = section;
      btn.classList.add("active");
      updateMap();
    }

    // --- Filtrering efter runderingstype ---
    function filterByType(type) {
      const btnMap = {
        indvendig: document.getElementById("indvBtn"),
        udvendig: document.getElementById("udvBtn"),
        begge: document.getElementById("beggeBtn")
      };
      Object.values(btnMap).forEach(b => b.classList.remove("active"));

      if (activeTypeFilter === type) {
        activeTypeFilter = null;
        updateMap();
        return;
      }
      activeTypeFilter = type;
      btnMap[type].classList.add("active");
      updateMap();
    }

    // --- Indlæs lørdag som standard ---
    loadDay("lordag.json");
  </script>
</body>
</html>
